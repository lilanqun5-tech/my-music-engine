name: AI Music Generator Engine
on:
  repository_dispatch:
    types: [start_composing]

jobs:
  compose:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install requests gradio_client huggingface_hub

      - name: Run Music Engine
        env:
          LYRICS: ${{ github.event.client_payload.lyrics }}
          STYLE: ${{ github.event.client_payload.style }}
          HF_TOKEN: ${{ secrets.HF_TOKEN }} # 调用保险箱里的 Token
        run: |
          python -c "
          from gradio_client import Client
          import os
          
          # 使用 Token 登录并调用模型
          client = Client('m-a-p/YuE-Music-1', hf_token=os.getenv('HF_TOKEN'))
          
          # 运行预测
          result = client.predict(
              lyrics=os.getenv('LYRICS'),
              genre=os.getenv('STYLE'),
              api_name='/predict'
          )
          print(f'歌曲已生成，存储路径：{result}')
          
          # 这一步是为了把生成的文件改名并移动到当前目录，方便后续上传
          import shutil
          if isinstance(result, str):
              shutil.copy(result, './final_song.mp3')
          elif isinstance(result, list):
              shutil.copy(result[0], './final_song.mp3')
          "

      - name: Upload Result
        uses: actions/upload-artifact@v4
        with:
          name: my-rap-song
          path: ./final_song.mp3
